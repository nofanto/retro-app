<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Retrospective Session App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    h1 { color: #2c3e50; }
    .container { max-width: 1000px; margin: auto; }
    .info { margin: 1rem 0; color: #555; }
    .session-form { margin: 2rem 0; }
    .session-key { font-weight: bold; color: #2980b9; }
    .hidden { display: none; }
    .error { color: #c0392b; }
    .kanban-board {
      display: flex;
      gap: 1.5rem;
      margin-top: 2rem;
      justify-content: center;
    }
    .kanban-column {
      background: #f4f6fa;
      border-radius: 8px;
      padding: 1rem;
      min-width: 250px;
      flex: 1 1 0;
      box-shadow: 0 2px 8px #0001;
      display: flex;
      flex-direction: column;
      max-height: 60vh;
    }
    .kanban-column h3 {
      margin-top: 0;
      text-align: center;
    }
    .kanban-list {
      list-style: none;
      padding: 0;
      margin: 0;
      flex: 1 1 0;
      overflow-y: auto;
      min-height: 40px;
    }
    .kanban-card {
      background: #fff;
      border-radius: 5px;
      margin-bottom: 0.5rem;
      padding: 0.5rem 0.75rem;
      box-shadow: 0 1px 3px #0002;
      cursor: grab;
      user-select: none;
    }
    .kanban-card.dragging {
      opacity: 0.5;
    }
    .kanban-add-form {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .kanban-add-form input {
      flex: 1 1 0;
      padding: 0.25rem 0.5rem;
    }
    .kanban-add-form button {
      padding: 0.25rem 0.75rem;
    }
    .timer-container {
      text-align: center;
      margin: 1rem 0;
      font-size: 1.2em;
      color: #2c3e50;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Retrospective Session App</h1>
    <div class="info">
      <p>Create a new session or join an existing one using a session key.</p>
    </div>
    <div class="session-form">
      <form id="create-session-form" style="display:inline;">
        <button type="submit" id="create-session-btn">Create New Session</button>
        <label for="timer-minutes" style="margin-left:1rem;">Timer (minutes):</label>
        <input type="number" id="timer-minutes" min="1" max="30" value="5" style="width:60px;">
      </form>
      <form id="join-session-form" style="display:inline;">
        <input type="text" id="join-session-key" placeholder="Session Key" required>
        <button type="submit">Join Session</button>
      </form>
      <div id="session-key-container" class="hidden">
        <p>Your session key: <span id="session-key" class="session-key"></span></p>
        <p>Share this key with participants to join your session.</p>
      </div>
      <div id="error-msg" class="error"></div>
    </div>
    <div id="session-area" class="hidden">
      <h2>Session: <span id="active-session-key"></span></h2>
      <div class="timer-container" id="timer-container"></div>
      <div class="kanban-board" id="kanban-board">
        <!-- Columns will be rendered here -->
      </div>
      <button id="export-json-btn" style="margin-top:1.5rem;">Export Session as JSON</button>
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentSessionKey = null;
    let feedbackData = [];
    let sessionPhase = "obfuscate";
    let timerInterval = null;
    let sessionEndTime = null;

    const createForm = document.getElementById('create-session-form');
    const createBtn = document.getElementById('create-session-btn');
    const timerInput = document.getElementById('timer-minutes');
    const joinForm = document.getElementById('join-session-form');
    const joinInput = document.getElementById('join-session-key');
    const sessionKeyContainer = document.getElementById('session-key-container');
    const sessionKeySpan = document.getElementById('session-key');
    const errorMsg = document.getElementById('error-msg');
    const sessionArea = document.getElementById('session-area');
    const activeSessionKey = document.getElementById('active-session-key');
    const kanbanBoard = document.getElementById('kanban-board');
    const exportBtn = document.getElementById('export-json-btn');
    const timerContainer = document.getElementById('timer-container');

    const COLUMNS = [
      { key: 'wentWell', label: 'Went Well' },
      { key: 'toImprove', label: 'To Improve' },
      { key: 'actionItem', label: 'Action Items' }
    ];

    createForm.onsubmit = (e) => {
      e.preventDefault();
      const minutes = parseInt(timerInput.value, 10);
      if (isNaN(minutes) || minutes < 1 || minutes > 30) {
        errorMsg.textContent = "Timer must be between 1 and 30 minutes.";
        return;
      }
      socket.emit('createSession', { duration: minutes });
    };

    joinForm.onsubmit = (e) => {
      e.preventDefault();
      const key = joinInput.value.trim();
      if (key) {
        socket.emit('joinSession', key);
      }
    };

    socket.on('sessionCreated', ({ key, duration, endTime }) => {
      currentSessionKey = key;
      sessionKeySpan.textContent = key;
      sessionKeyContainer.classList.remove('hidden');
      errorMsg.textContent = '';
      joinForm.style.display = 'none';
      createForm.style.display = 'none';
      sessionArea.classList.remove('hidden');
      activeSessionKey.textContent = key;
      sessionPhase = "obfuscate";
      sessionEndTime = endTime;
      startTimer();
      requestFeedback();
    });

    socket.on('sessionJoined', ({ key, duration, endTime, phase }) => {
      currentSessionKey = key;
      sessionKeyContainer.classList.add('hidden');
      errorMsg.textContent = '';
      joinForm.style.display = 'none';
      createForm.style.display = 'none';
      sessionArea.classList.remove('hidden');
      activeSessionKey.textContent = key;
      sessionPhase = phase || "obfuscate";
      sessionEndTime = endTime;
      startTimer();
      requestFeedback();
    });

    socket.on('sessionError', (msg) => {
      errorMsg.textContent = msg;
    });

    function startTimer() {
      if (!sessionEndTime) return;
      clearInterval(timerInterval);
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
    }

    function updateTimer() {
      if (!sessionEndTime) return;
      const now = Date.now();
      const msLeft = sessionEndTime - now;
      if (msLeft > 0 && sessionPhase === "obfuscate") {
        const min = Math.floor(msLeft / 60000);
        const sec = Math.floor((msLeft % 60000) / 1000);
        timerContainer.textContent = `Time left: ${min}:${sec.toString().padStart(2, '0')}`;
      } else if (sessionPhase === "obfuscate") {
        timerContainer.textContent = "Time's up! Revealing feedback...";
      } else {
        timerContainer.textContent = "";
        clearInterval(timerInterval);
      }
    }

    // Kanban rendering
    function renderKanban(feedbackArr) {
      kanbanBoard.innerHTML = '';
      COLUMNS.forEach(col => {
        const colDiv = document.createElement('div');
        colDiv.className = 'kanban-column';
        colDiv.dataset.column = col.key;

        const h3 = document.createElement('h3');
        h3.textContent = col.label;
        colDiv.appendChild(h3);

        // Add form
        if (sessionPhase === "obfuscate") {
          const form = document.createElement('form');
          form.className = 'kanban-add-form';
          form.onsubmit = (e) => {
            e.preventDefault();
            const input = form.querySelector('input');
            const text = input.value.trim();
            if (text && currentSessionKey) {
              socket.emit('addFeedback', { sessionKey: currentSessionKey, text, type: col.key });
              input.value = '';
            }
          };
          const input = document.createElement('input');
          input.type = 'text';
          input.placeholder = `Add to "${col.label}"...`;
          form.appendChild(input);
          const btn = document.createElement('button');
          btn.type = 'submit';
          btn.textContent = 'Add';
          form.appendChild(btn);
          colDiv.appendChild(form);
        }

        // List
        const ul = document.createElement('ul');
        ul.className = 'kanban-list';
        ul.dataset.column = col.key;

        // Drag-and-drop events (only after reveal)
        if (sessionPhase !== "obfuscate") {
          ul.ondragover = (e) => {
            e.preventDefault();
            ul.style.background = '#e0e7ef';
          };
          ul.ondragleave = () => {
            ul.style.background = '';
          };
          ul.ondrop = (e) => {
            e.preventDefault();
            ul.style.background = '';
            const feedbackId = e.dataTransfer.getData('text/plain');
            if (feedbackId && currentSessionKey) {
              socket.emit('moveFeedback', { sessionKey: currentSessionKey, feedbackId, newType: col.key });
            }
          };
        }

        feedbackArr.filter(item => item.type === col.key).forEach(item => {
          const li = document.createElement('li');
          li.className = 'kanban-card';
          if (sessionPhase === "obfuscate") {
            li.textContent = "Feedback added";
          } else {
            li.textContent = item.text;
            li.draggable = true;
            li.dataset.id = item.id;
            li.ondragstart = (e) => {
              li.classList.add('dragging');
              e.dataTransfer.setData('text/plain', item.id);
            };
            li.ondragend = () => {
              li.classList.remove('dragging');
            };
          }
          ul.appendChild(li);
        });

        colDiv.appendChild(ul);
        kanbanBoard.appendChild(colDiv);
      });
    }

    // Receive feedback update
    socket.on('feedbackUpdate', (feedbackArr) => {
      feedbackData = feedbackArr;
      renderKanban(feedbackArr);
    });

    // Receive phase update
    socket.on('phaseUpdate', ({ phase, endTime }) => {
      sessionPhase = phase;
      sessionEndTime = endTime;
      startTimer();
      renderKanban(feedbackData);
    });

    // Request feedback list after joining/creating session
    function requestFeedback() {
      if (currentSessionKey) {
        socket.emit('getFeedback', currentSessionKey);
      }
    }

    // Export session as JSON
    if (exportBtn) {
      exportBtn.onclick = () => {
        if (currentSessionKey) {
          window.open(`/export/${currentSessionKey}`, '_blank');
        }
      };
    }
  </script>
</body>
</html>